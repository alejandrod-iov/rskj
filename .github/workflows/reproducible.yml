name: Reproducible build
on: [pull_request]

jobs:
  jar-artifact-and-hash:
    runs-on: ubuntu-20.04
    container: 
      image: openjdk:8-jdk-slim-buster
    steps:
      - name: Install packages
        run: |
          apt-get update -y && apt-get install -y git curl gnupg
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Verify files integrity
        run: |
          gpg --keyserver https://secchannel.rsk.co/release.asc --recv-keys 1A92D8942171AFA951A857365DECF4415E3B8FA4
          gpg --verify --output SHA256SUMS SHA256SUMS.asc && sha256sum --check SHA256SUMS

      - name: Build rskj
        run: |
          ./configure.sh && ./gradlew --no-daemon clean build -x test

      - name: Calculate hashes      
        working-directory: rskj-core/build/libs
        run: |
          for i in `ls | grep -E 'rskj-core.*all*.jar'`; do
            sha256sum ${i} >> SHA256SUMS;
          done
          cat SHA256SUMS
          echo ::set-output name=sha256sum::$(cat SHA256SUMS)

      - name: Export reproducible
        run: |
          echo "Here we will push to s3 bucket"

      - name: 'Comment PR'
        uses: actions/github-script@0.3.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `Reproducible builds allow you to match our provided binary with the source code you 
            find on the repository. As more people reproduce the code, the more sure you can be 
            that the code has not been tampered with.
                        
            **Want the binary and sha256 sum:?**: Follow this [link]().
            **Want to reproduce?**: Follow this [guide](https://developers.rsk.co/rsk/node/reproducible/). Share your results with the rest of the community on this PR!`
            const { issue: { number: issue_number }, repo: { owner, repo }  } = context;
            github.issues.createComment({ issue_number, owner, repo, body: comment });